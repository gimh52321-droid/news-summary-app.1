from flask import Flask, render_template, request, redirect, url_for, session, jsonify
import requests
from bs4 import BeautifulSoup
import re
import os

app = Flask(__name__)
app.secret_key = "secret_key_example"

# -------------------------
# ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ URL
# -------------------------
news_urls = {
    "ê²½ì œ": "https://news.naver.com/section/101",
    "ì‚¬íšŒ": "https://news.naver.com/section/102",
    "ì„¸ê³„": "https://news.naver.com/section/104"
}

# -------------------------
# ì£¼ì œë³„ ë‹¨ì–´ ì‚¬ì „
# -------------------------
predefined_words = {
    "ê²½ì œ": {
        "ì¸í”Œë ˆì´ì…˜": "í™”í ê°€ì¹˜ í•˜ë½ìœ¼ë¡œ ì¸í•´ ë¬¼ê°€ê°€ ì „ë°˜ì ìœ¼ë¡œ ìƒìŠ¹í•˜ëŠ” í˜„ìƒ",
        "ê¸ˆë¦¬": "ëˆì„ ë¹Œë¦´ ë•Œ ì ìš©ë˜ëŠ” ì´ììœ¨",
        "í™˜ìœ¨": "ë‘ ë‚˜ë¼ í†µí™”ì˜ êµí™˜ ë¹„ìœ¨",
        "ì¦ì‹œ": "ì£¼ì‹ ì‹œì¥",
        "ì±„ê¶Œ": "ì •ë¶€ë‚˜ ê¸°ì—…ì´ ë°œí–‰í•˜ëŠ” ë¹š ë¬¸ì„œ",
        "ê²½ê¸°ë¶€ì–‘": "ê²½ì œë¥¼ í™œì„±í™”ì‹œí‚¤ê¸° ìœ„í•œ ì •ì±…",
        "ì¬ì •ì •ì±…": "ì •ë¶€ê°€ ì„¸ê¸ˆê³¼ ì§€ì¶œë¡œ ê²½ì œë¥¼ ì¡°ì ˆí•˜ëŠ” ì •ì±…",
        "í†µí™”ì •ì±…": "ì¤‘ì•™ì€í–‰ì´ ê¸ˆë¦¬ì™€ í™”í ê³µê¸‰ì„ ì¡°ì ˆí•˜ëŠ” ì •ì±…",
        "ë¶€ë™ì‚°": "í† ì§€ë‚˜ ê±´ë¬¼ ë“± ê³ ì • ìì‚°",
        "ì‹œì¥ì ìœ ìœ¨": "í•œ ê¸°ì—…ì´ ì‹œì¥ì—ì„œ ì°¨ì§€í•˜ëŠ” ë¹„ìœ¨",
        "ìì‚°": "ê°€ì¹˜ê°€ ìˆëŠ” ì¬ì‚°",
        "ì ì": "ìˆ˜ì…ë³´ë‹¤ ì§€ì¶œì´ ë” ë§ì€ ìƒíƒœ",
        "í‘ì": "ìˆ˜ì…ì´ ì§€ì¶œë³´ë‹¤ ë§ì€ ìƒíƒœ",
        "íˆ¬ì": "ìˆ˜ìµì„ ëª©ì ìœ¼ë¡œ ìë³¸ì„ íˆ¬ì…í•˜ëŠ” í–‰ìœ„",
        "íŒŒì‚°": "ê²½ì œì  ì§€ê¸‰ ë¶ˆëŠ¥ ìƒíƒœ",
        "ë””í”Œë ˆì´ì…˜": "ì „ë°˜ì ì¸ ë¬¼ê°€ê°€ í•˜ë½í•˜ëŠ” í˜„ìƒ",
        "ë²¤ì²˜": "ìƒˆë¡œìš´ ì‚¬ì—… ì•„ì´ë””ì–´ë¥¼ ê°€ì§„ ì‹ ìƒ ê¸°ì—…",
        "ì£¼ì‹ë°°ë‹¹": "ì£¼ì‹ ì†Œìœ ìì—ê²Œ ì´ìµì˜ ì¼ë¶€ë¥¼ ë¶„ë°°í•˜ëŠ” ê²ƒ"
    },
    "ì‚¬íšŒ": {
        "ë³µì§€": "êµ­ê°€ê°€ êµ­ë¯¼ì˜ ìƒí™œ ì•ˆì •ì„ ìœ„í•´ ì§€ì›í•˜ëŠ” ì •ì±…",
        "ì²­ë…„ì‹¤ì—…": "ì²­ë…„ì¸µì˜ ì¼ìë¦¬ ë¶€ì¡± í˜„ìƒ",
        "ë…¸ë™ì‹œì¥": "ë…¸ë™ë ¥ì´ ê±°ë˜ë˜ëŠ” ì‹œì¥",
        "ê³ ë ¹í™”": "ì¸êµ¬ì—ì„œ ë…¸ì¸ ë¹„ìœ¨ì´ ì¦ê°€í•˜ëŠ” í˜„ìƒ",
        "ë²”ì£„ìœ¨": "ë²”ì£„ ë°œìƒ ë¹„ìœ¨",
        "ì¬ë‚œ": "ìì—°ì¬í•´ë‚˜ ì‚¬ê³ ë¡œ ì¸í•œ í”¼í•´",
        "ì •ì±…": "ì •ë¶€ê°€ ì¶”ì§„í•˜ëŠ” ê³„íšì´ë‚˜ ë²•ë¥ ",
        "ì‹œë¯¼ê¶Œ": "êµ­ê°€ê°€ êµ­ë¯¼ì—ê²Œ ë¶€ì—¬í•˜ëŠ” ê¶Œë¦¬",
        "í™˜ê²½ì˜¤ì—¼": "ìì—° í™˜ê²½ì´ ì˜¤ì—¼ë˜ëŠ” í˜„ìƒ",
        "êµìœ¡ê²©ì°¨": "í•™ìƒ ê°„ í•™ìŠµ ê¸°íšŒì™€ ì„±ì·¨ ì°¨ì´",
        "ë³µì§€ì‚¬ê°ì§€ëŒ€": "ë³µì§€ í˜œíƒì´ ë¯¸ì¹˜ì§€ ì•ŠëŠ” ì˜ì—­",
        "ì¸ê¶Œ": "ê°œì¸ì—ê²Œ ë³´ì¥ëœ ê¸°ë³¸ì ì¸ ê¶Œë¦¬",
        "ì‚¬íšŒì ê¸°ì—…": "ì‚¬íšŒì  ëª©ì ì„ ê°€ì§„ ê¸°ì—…",
        "ì¬ë‚œêµ¬í˜¸": "ì¬ë‚œ ë°œìƒ ì‹œ ì§€ì› í™œë™",
        "ë…¸ë™ì¡°í•©": "ë…¸ë™ì ê¶Œìµì„ ë³´í˜¸í•˜ê¸° ìœ„í•œ ì¡°ì§",
        "ì  ë”": "ì‚¬íšŒì  ì„± ì—­í•  ë° ì„±ì°¨ ë¬¸ì œ",
        "ì²­ì†Œë…„ë³´í˜¸": "ì²­ì†Œë…„ì˜ ê¶Œë¦¬ì™€ ì•ˆì „ì„ ë³´í˜¸í•˜ëŠ” ì •ì±…"
    },
    "ì„¸ê³„": {
        "êµ­ì œê¸°êµ¬": "êµ­ê°€ ê°„ í˜‘ë ¥ì„ ìœ„í•´ ì„¤ë¦½ëœ ê¸°êµ¬",
        "ë¶„ìŸ": "ë‘ êµ­ê°€ ë˜ëŠ” ì§‘ë‹¨ ê°„ ê°ˆë“±",
        "ì „ìŸ": "ë¬´ë ¥ ì¶©ëŒ",
        "í‰í™”í˜‘ì •": "ì „ìŸì„ ëë‚´ê¸° ìœ„í•œ í•©ì˜",
        "ì¸ê¶Œì¹¨í•´": "ì‚¬ëŒì˜ ê¶Œë¦¬ê°€ ì¹¨í•´ë˜ëŠ” í–‰ìœ„",
        "ë‚œë¯¼": "ìêµ­ì„ ë– ë‚˜ ë‹¤ë¥¸ ë‚˜ë¼ë¡œ í”¼ì‹ í•œ ì‚¬ëŒ",
        "ê²½ì œì œì¬": "êµ­ì œì ìœ¼ë¡œ ê°€í•˜ëŠ” ê²½ì œì  ì œí•œ",
        "ì™¸êµ": "êµ­ê°€ ê°„ ê´€ê³„ë¥¼ ê´€ë¦¬í•˜ëŠ” í™œë™",
        "êµ­ì œë²•": "êµ­ì œ ì‚¬íšŒì—ì„œ ì¸ì •ë˜ëŠ” ë²•",
        "ë¬´ì—­ë¶„ìŸ": "êµ­ê°€ ê°„ ë¬´ì—­ ê°ˆë“±",
        "ê¸°í›„ë³€í™”": "ì§€êµ¬ ê¸°í›„ì˜ ì¥ê¸°ì  ë³€í™”",
        "í™˜ê²½ë³´í˜¸": "ìì—°ê³¼ í™˜ê²½ì„ ì§€í‚¤ëŠ” í™œë™",
        "í…ŒëŸ¬": "ê³µí¬ë¥¼ ì¡°ì¥í•˜ëŠ” í­ë ¥ í–‰ìœ„",
        "ìœ ì—”": "êµ­ì œ ì—°í•©",
        "ê¸€ë¡œë²Œí™”": "ì„¸ê³„ê°€ ê²½ì œ, ë¬¸í™”, ì •ì¹˜ì ìœ¼ë¡œ ì—°ê²°ë˜ëŠ” í˜„ìƒ",
        "ë¸Œë ‰ì‹œíŠ¸": "ì˜êµ­ì˜ EU íƒˆí‡´",
        "ë‚œë¯¼í˜‘ì•½": "ë‚œë¯¼ ë³´í˜¸ë¥¼ ìœ„í•œ êµ­ì œ ì¡°ì•½"
    },
    "IT": {
        "í´ë¼ìš°ë“œ": "ì¸í„°ë„· ê¸°ë°˜ìœ¼ë¡œ ì œê³µë˜ëŠ” ì»´í“¨íŒ… ì„œë¹„ìŠ¤",
        "ë¹…ë°ì´í„°": "ëŒ€ê·œëª¨ ë°ì´í„° ë¶„ì„ ê¸°ìˆ ",
        "ì¸ê³µì§€ëŠ¥": "ì‚¬ëŒì²˜ëŸ¼ í•™ìŠµ, ì¶”ë¡ , íŒë‹¨í•˜ëŠ” ê¸°ìˆ ",
        "ë¨¸ì‹ ëŸ¬ë‹": "ê¸°ê³„ê°€ í•™ìŠµí•˜ë„ë¡ í•˜ëŠ” ê¸°ìˆ ",
        "ë”¥ëŸ¬ë‹": "ì¸ê³µì‹ ê²½ë§ ê¸°ë°˜ì˜ í•™ìŠµ ê¸°ìˆ ",
        "ë¸”ë¡ì²´ì¸": "ë¶„ì‚°í˜• ê±°ë˜ ê¸°ë¡ ê¸°ìˆ ",
        "ê°€ìƒí™”í": "ë””ì§€í„¸ í˜•íƒœì˜ í™”í",
        "ì‚¬ì´ë²„ë³´ì•ˆ": "ì¸í„°ë„· ë° ì‹œìŠ¤í…œ ë³´í˜¸ ê¸°ìˆ ",
        "IoT": "ì‚¬ë¬¼ì¸í„°ë„·",
        "ì•Œê³ ë¦¬ì¦˜": "ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë‹¨ê³„ì  ì ˆì°¨",
        "ë°ì´í„°ë§ˆì´ë‹": "ë°ì´í„°ì—ì„œ ì˜ë¯¸ ìˆëŠ” ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” ê¸°ìˆ ",
        "API": "ì†Œí”„íŠ¸ì›¨ì–´ ê¸°ëŠ¥ì„ ì—°ê²°í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤",
        "í”„ë¡œê·¸ë˜ë°": "ì»´í“¨í„° í”„ë¡œê·¸ë¨ ì‘ì„± í™œë™",
        "ë„¤íŠ¸ì›Œí¬": "ì»´í“¨í„° ê°„ ì—°ê²°ë§",
        "í´ë¼ì´ì–¸íŠ¸": "ì„œë¹„ìŠ¤ë¥¼ ë°›ëŠ” ì¸¡ ì‹œìŠ¤í…œ",
        "ì„œë²„": "ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ëŠ” ì¸¡ ì‹œìŠ¤í…œ"
    },
    "ì •ì¹˜": {
        "ë¯¼ì£¼ì£¼ì˜": "êµ­ë¯¼ì´ ì£¼ê¶Œì„ ê°€ì§€ê³  ì •ì¹˜ì— ì°¸ì—¬í•˜ëŠ” ì œë„",
        "ì„ ê±°": "êµ­ë¯¼ì´ ëŒ€í‘œìë¥¼ ë½‘ëŠ” ê³¼ì •",
        "ì •ë‹¹": "ê³µí†µì˜ ì •ì¹˜ ëª©ì ì„ ê°€ì§„ ì¡°ì§",
        "ê¶Œë ¥ë¶„ë¦½": "êµ­ê°€ ê¶Œë ¥ì„ ë‚˜ëˆ„ì–´ ê²¬ì œí•˜ëŠ” ì œë„",
        "í—Œë²•": "êµ­ê°€ì˜ ê¸°ë³¸ ë²•",
        "ë²•ë¥ ": "êµ­ë¯¼ì˜ ê¶Œë¦¬ì™€ ì˜ë¬´ë¥¼ ê·œì •í•œ ê·œë²”",
        "êµ­íšŒì˜ì›": "êµ­íšŒë¥¼ êµ¬ì„±í•˜ëŠ” ëŒ€í‘œ",
        "í–‰ì •": "êµ­ê°€ ì •ì±… ì§‘í–‰ í™œë™",
        "ì‚¬ë²•": "ë²•ì„ í•´ì„í•˜ê³  ì ìš©í•˜ëŠ” ê¶Œí•œ",
        "íˆ¬í‘œ": "ì˜ê²¬ì„ í‘œì‹œí•˜ì—¬ ì„ ì¶œí•˜ëŠ” í–‰ìœ„",
        "ì •ì±…ê²°ì •": "ì •ì±…ì„ ë§Œë“¤ê³  ì§‘í–‰í•˜ëŠ” ê³¼ì •",
        "ì™¸êµì •ì±…": "êµ­ê°€ ê°„ ê´€ê³„ë¥¼ ê´€ë¦¬í•˜ëŠ” ì •ì±…",
        "ì„ ê±°ë²•": "ì„ ê±° ê´€ë ¨ ë²•ë¥ ",
        "ì •ì¹˜ìê¸ˆ": "ì •ì¹˜ í™œë™ì— ì‚¬ìš©ë˜ëŠ” ìê¸ˆ",
        "êµ­ë°©": "êµ­ê°€ë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•œ êµ°ì‚¬ í™œë™"
    },
    "ìƒí™œë¬¸í™”": {
        "íŠ¸ë Œë“œ": "ì‚¬íšŒ ì „ë°˜ì— ìœ í–‰í•˜ëŠ” ê²½í–¥",
        "ë¬¸í™”ì¬": "ì—­ì‚¬ì  ê°€ì¹˜ê°€ ìˆëŠ” ìœ ì‚°",
        "ìƒí™œìš©í’ˆ": "ì¼ìƒì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¬¼í’ˆ",
        "ê±´ê°•ê´€ë¦¬": "ëª¸ê³¼ ë§ˆìŒì„ ëŒë³´ëŠ” í™œë™",
        "ì‹ë¬¸í™”": "ìŒì‹ê³¼ ê´€ë ¨ëœ ë¬¸í™”",
        "ì—¬í–‰ì§€": "ê´€ê´‘í•  ë§Œí•œ ì¥ì†Œ",
        "ì·¨ë¯¸": "ì—¬ê°€ í™œë™ê³¼ ê´€ì‹¬ì‚¬",
        "íŒ¨ì…˜": "ì˜ë³µê³¼ ìŠ¤íƒ€ì¼ ë¬¸í™”",
        "ë·°í‹°": "ì™¸ëª¨ì™€ ê´€ë ¨ëœ ê´€ë¦¬",
        "ìš”ë¦¬": "ìŒì‹ì„ ë§Œë“œëŠ” í™œë™",
        "ì „í†µë¬¸í™”": "ì˜¤ë˜ì „ë¶€í„° ì „í•´ ë‚´ë ¤ì˜¤ëŠ” ë¬¸í™”",
        "ì˜ˆìˆ ": "ì¸ê°„ì˜ ì°½ì‘ í™œë™ê³¼ ì‘í’ˆ",
        "ê³µì—°": "ìŒì•…, ì—°ê·¹ ë“± ê³µì—° í™œë™",
        "ì¶•ì œ": "ì§€ì—­ ë˜ëŠ” êµ­ê°€ ë‹¨ìœ„ í–‰ì‚¬",
         "ìƒí™œì •ë³´": "ì¼ìƒ ìƒí™œì— í•„ìš”í•œ ì •ë³´"
    }
}
# âš ï¸ ì‹¤ì œ ì½”ë“œì—ì„œëŠ” ë„¤ê°€ ì˜¬ë¦° predefined_words ê·¸ëŒ€ë¡œ ë‘ë©´ ë¨

# -------------------------
# ê¸°ì‚¬ ë³¸ë¬¸ ê°€ì ¸ì˜¤ê¸° (ì•ˆì •í™”)
# -------------------------
def get_article_text(url):
    try:
        res = requests.get(
            url,
            headers={"User-Agent": "Mozilla/5.0"},
            timeout=5
        )
        soup = BeautifulSoup(res.text, "html.parser")
        content = (
            soup.select_one("#dic_area")
            or soup.select_one("div#articleBodyContents")
            or soup.select_one("div.news_end")
        )

        if not content:
            return ""

        text = content.get_text(separator=" ", strip=True)
        text = re.sub(r"\s+", " ", text)

        # ğŸ”¥ ë©”ëª¨ë¦¬ ë³´í˜¸: ë³¸ë¬¸ ìµœëŒ€ 3000ì
        return text[:3000]

    except Exception:
        return ""

# -------------------------
# ë‰´ìŠ¤ ìš”ì•½ (Render ì•ˆì „ ë²„ì „)
# -------------------------
def smart_summary(text, max_len=500):
    if not text:
        return ""
    summary = text[:max_len]
    if not summary.endswith((".", "!", "?")):
        summary += "."
    return summary

# -------------------------
# ë‰´ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì¹´í…Œê³ ë¦¬ë‹¹ 10ê°œ)
# -------------------------
def get_news(url):
    try:
        res = requests.get(url, headers={"User-Agent": "Mozilla/5.0"}, timeout=5)
        soup = BeautifulSoup(res.text, "html.parser")
    except Exception:
        return []

    news_items = []
    candidates = soup.select("div.sa_item_inner") or soup.select("ul.list_news li")

    for i, item in enumerate(candidates[:10]):  # ğŸ”¥ 10ê°œ ì œí•œ
        title_tag = item.select_one("a.sa_text_title") or item.select_one("a")
        if not title_tag:
            continue

        link = title_tag.get("href")
        if not link:
            continue

        full_text = get_article_text(link)

        news_items.append({
            "id": i + 1,
            "title": title_tag.get_text(strip=True),
            "link": link,
            "summary": smart_summary(full_text),
            "content": full_text
        })

    return news_items

# -------------------------
# ë©”ì¸ í˜ì´ì§€
# -------------------------
@app.route("/")
def index():
    query = request.args.get("query", "").strip()
    news_data = {}

    for cat, url in news_urls.items():
        articles = get_news(url)
        if query:
            articles = [
                a for a in articles
                if query in a["title"] or query in a["content"]
            ]
        news_data[cat] = articles

    return render_template(
        "index.html",
        news_data=news_data,
        favorites=session.get("favorites", []),
        wordbook=session.get("wordbook", []),
        query=query
    )

# -------------------------
# ë‹¨ì–´ ëœ» ì¡°íšŒ
# -------------------------
@app.route("/api/define")
def define_word():
    word = request.args.get("word", "").strip()
    meanings = []
    for words in predefined_words.values():
        if word in words:
            meanings.append(words[word])
    return jsonify({"meanings": meanings or ["ëœ»ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."]})

# -------------------------
# ë‹¨ì–´ì¥
# -------------------------
@app.route("/add_word", methods=["POST"])
def add_word():
    data = request.get_json(silent=True) or {}
    word = data.get("word", "").strip()
    meanings = data.get("meanings", [])

    if not word:
        return jsonify(success=False)

    wb = session.get("wordbook", [])
    wb = [w for w in wb if w["word"] != word]
    wb.insert(0, {"word": word, "meanings": meanings})

    session["wordbook"] = wb[:20]
    return jsonify(success=True)

@app.route("/wordbook")
def wordbook_page():
    return render_template("wordbook.html", wordbook=session.get("wordbook", []))

@app.route("/delete_word", methods=["POST"])
def delete_word():
    data = request.get_json(silent=True) or {}
    word = data.get("word")
    session["wordbook"] = [
        w for w in session.get("wordbook", [])
        if w["word"] != word
    ]
    return jsonify(success=True)

# -------------------------
# ì¦ê²¨ì°¾ê¸°
# -------------------------
@app.route("/favorite/<path:title>")
def add_favorite(title):
    fav = session.get("favorites", [])
    if title not in fav:
        fav.append(title)
    session["favorites"] = fav
    return redirect(url_for("index"))

@app.route("/unfavorite/<path:title>")
def remove_favorite(title):
    fav = session.get("favorites", [])
    if title in fav:
        fav.remove(title)
    session["favorites"] = fav
    return redirect(url_for("index"))

@app.route("/favorites")
def show_favorites():
    return render_template("favorites.html", favorites=session.get("favorites", []))

# -------------------------
# ì‹¤í–‰ (Render ëŒ€ì‘)
# -------------------------
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
